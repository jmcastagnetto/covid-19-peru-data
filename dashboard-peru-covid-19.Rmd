---
title: "COVID-19 en Perú (v0.6) "
#author: "[Jesus M. Castagnetto]"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    navbar:
      - {title: "", icon: "fab fa-twitter", href: "https://twitter.com/share?text=COVID-19+en+Perú&url=https://castagnetto.site/peru/dashboard-peru-covid-19.html", target: "_blank"}
      - {title: "", icon: "fab fa-linkedin", href: "https://www.linkedin.com/shareArticle?mini=true&url=https://castagnetto.site/peru/dashboard-peru-covid-19.html&title=COVID-19+en+Perú", target: "_blank"}
      - {title: "Código fuente",  icon: "fab fa-github", href: "https://github.com/jmcastagnetto/covid-19-peru-data", target: "_blank"}
    vertical_layout: fill
    includes:
      in_header: _ga.html
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(patchwork)
library(DT)
library(echarts4r)
library(echarts4r.maps)
library(showtext)
library(plotly)
library(ggiraph)
library(ggiraphExtra)

font_add_google("Inconsolata", "inconsolata")
font_add_google("Lato", "lato")

showtext_auto()

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE
)

last_updated <- paste0(
  "Actualizado el ",
  lubridate::now(tzone = "UTC"), 
  " UTC"
)

jmc <- "@jmcastagnetto, Jesús M. Castagnetto"
minsa <- "Fuente: Tweets del MINSA https://twitter.com/Minsa_Peru"

covid_pe <- read_csv("datos/covid-19-peru-data.csv") %>% 
  filter(is.na(region)) %>% 
  select(-region)

covid_regions_pe <- read_csv(
  "datos/covid-19-peru-data-con-ubigeos.csv"
) %>%
  filter(!is.na(region)) %>% 
  select(region, date, confirmed, pob_2017) %>% 
  distinct() %>% 
  mutate(
    confirmed_per_million = round(confirmed * 1e6 / pob_2017, 2)
  )

cur_theme <- theme(
  plot.margin = unit(rep(1, 4), "cm"),
  plot.title = element_text(family = "lato"),
  plot.subtitle = element_text(family = "lato"),
  plot.caption = element_text(family = "inconsolata"),
  legend.position = "none"
)
```

# Gráficos totales

## Columna izquierda {.tabset}


### Situación general

```{r}
sit_pe <- covid_pe %>% 
  slice_tail(n = 3) %>% 
  select(-country, -iso3c) %>% 
  arrange(date)

datatable(
  sit_pe,
  rownames = FALSE,
  colnames = c("Fecha", "Casos confirmados", "Fallecimientos", "Casos recuperados", "Casos descartados"),
  caption = "COVID-19 en Perú: últimos tres días",
  options = list(
    dom = "t",
    columnDefs = list(list(className = 'dt-center', targets = 1:4)),
    initComplete = JS(
      "function(settings, json) {",
      "$(this.api().table().header()).css({'font-size': '180%'});",
      "}"
      ) #,
  #ordering = FALSE
  )
) %>% 
  formatStyle(1:5, fontSize = "180%") %>% 
  formatStyle(
    "confirmed", 
    color = "black", 
    #backgroundColor = "orange",
    background = styleColorBar(sit_pe$confirmed, 'orange'),
    backgroundSize = '90% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>% 
  formatStyle(
    "deaths", 
    color = "black", 
    background = styleColorBar(sit_pe$deaths, '#ff3333'),
    backgroundSize = '90% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>% 
  formatStyle(
    "recovered",
    color = "black", 
    background = styleColorBar(sit_pe$recovered, 'lightgreen'),
    backgroundSize = '90% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>% 
  formatStyle(
    "negative_cases", 
    color = "black",
    background = styleColorBar(sit_pe$negative_cases, 'cyan'),
    backgroundSize = '90% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  ) %>%
  formatCurrency(2:5, currency = "", digits = 0)
```

background = styleColorBar(iris$Petal.Length, 'steelblue'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'

### Casos Confirmados

```{r}
pe_plot <- ggplot(covid_pe,
       aes(x = date, y = confirmed)) +
  geom_point_interactive(aes(tooltip = confirmed)) +
  geom_line() +
  geom_vline_interactive(xintercept = as.Date("2020-03-16"), color = "blue", size = 2, alpha = .5) +
  annotate_interactive(geom = "text", x = as.Date("2020-03-16"), y = 300, hjust = 1.1,
           label = "Inicio de la\ncuarentena", color = "blue") +
  theme_minimal() +
  labs(
    y = "Casos Confirmados",
    x = "",
    title = "COVID-19: Casos totales confirmados en el Perú",
    subtitle = minsa,
    caption = paste0(last_updated, " // ", jmc)
  ) +
  cur_theme

girafe(
  ggobj = pe_plot,
  options = list(
    opts_zoom(max = 5)
  )
)
```

### Trayectoria de Casos Confirmados

```{r}
traj_df <- covid_pe %>% 
  select(date, confirmed) %>% 
  mutate(
    new_confirmed = confirmed - lag(confirmed, 7)
  ) %>% 
  filter(!is.na(new_confirmed))

pelog_plot <- ggplot(traj_df,
       aes(x = confirmed, y = new_confirmed)) +
  geom_point(size = 2) +
  #geom_line() +
  geom_smooth(method = "lm", linetype = "dashed", alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10() +
  annotation_logticks() +
  theme_minimal() +
  labs(
    y = "Nuevos casos confirmados\n(luego de 7 días)",
    x = "Casos confirmados",
    title = "COVID-19: Trayectoria de los casos confirmados en el Perú",
    subtitle = minsa,
    caption = paste0(last_updated, " // ", jmc)
  ) +
  cur_theme

pelog_plot
```

### Casos tamizados

```{r fig.width=12}
df <- covid_pe %>% 
  rename(
    Confirmados = confirmed,
    Descartados = negative_cases
  ) %>% 
  pivot_longer(
    cols = c("Confirmados", "Descartados"),
    names_to = "Casos tamizados",
    values_to = "cases"
  ) %>% 
  select(
    date, `Casos tamizados`, cases
  )

bar_plot <- ggplot(df, 
       aes(x = date, y = cases, fill = `Casos tamizados`)) +
  geom_col() +
  theme_minimal() +
  labs(
    y = "Número de casos",
    x = "",
    title = "COVID-19: Casos totales tamizados en el Perú",
    subtitle = minsa,
    caption = paste0(last_updated, "\n", jmc)
  ) +
  cur_theme

ggplotly(bar_plot)
```

### Casos recuperados y fallecimientos

```{r}
recdth <- covid_pe %>% 
  select(date, recovered, deaths) %>% 
  rename(
    Recuperados = recovered,
    Fallecidos = deaths
  ) %>% 
  pivot_longer(
    cols = c(Recuperados, Fallecidos),
    names_to = "Estado",
    values_to = "cases"
  ) %>% 
  filter(!is.na(cases)) %>% 
  mutate(
    label = paste0(Estado, ": ", cases)
  )

rd_plot <- ggplot(recdth, aes(x = date, y = cases, group = Estado, fill = Estado)) +
  geom_col_interactive(aes(tooltip = label), 
                           position = "dodge", width = 0.5) +
  #geom_line() +
  theme_minimal() +
  labs(
    y = "Número de personas",
    x = "",
    title = "COVID-19: Recuperados y fallecidos en Perú",
    subtitle = minsa,
    caption = paste0(last_updated, "\n", jmc)
  ) + 
  cur_theme

girafe(
  ggobj = rd_plot,
  options = list(
    opts_zoom(max = 5)
  )
)
#ggplotly(rd_plot)
```



## Columna derecha

### Nuevos casos confirmados totales


```{r fig.width=10}
df2 <- covid_pe %>% 
  mutate(
    new_conf = confirmed - lag(confirmed),
    new_disc = negative_cases - lag(negative_cases),
    new_tot = new_conf + new_disc
  ) %>%
  filter(!is.na(new_conf))

pt1 <- ggplot(df2, aes(x = date, y = new_conf)) +
  geom_point() +
  geom_segment(aes(xend = date, yend = 0)) +
  theme_minimal() +
  labs(
    y = "Casos confirmados",
    x = "",
    title = "COVID-19: Nuevos casos confirmados (Perú)",
    subtitle = minsa,
    caption = paste0(last_updated, "\n", jmc)
  ) +
  cur_theme

pt2 <- ggplot(df2, aes(x = date, y = new_tot)) +
  geom_point(color = "blue") +
  geom_segment(aes(xend = date, yend = 0), color = "blue") +
  theme_minimal() +
  labs(
    y = "Casos tamizados",
    x = "",
    title = "COVID-19: Nuevos casos tamizados totales (Perú)",
    subtitle = minsa,
    caption = paste0(last_updated, "\n", jmc)
  ) +
  cur_theme

ggplotly(pt1)
```

### Nuevos casos tamizados totales

```{r}
ggplotly(pt2)
```


# Gráficos por regiones

## Columna izquierda {.tabset}

### Casos confirmados por región

```{r echo=FALSE}
last_date_index <- covid_regions_pe %>% 
  select(date) %>% 
  distinct() %>% 
  nrow()
map_df <- covid_regions_pe %>% 
  select(region, date, confirmed) %>% 
  mutate(
    region = str_to_title(region) %>% 
      str_replace("Huanuco", "Huánuco") %>% 
      str_replace("Junin", "Junín") %>% 
      str_replace("De Dios", "de Dios") %>% 
      str_replace("Martin", "Martín") %>% 
      str_replace("Apurimac", "Apurímac")
  )

map_df %>% 
  group_by(date) %>% 
  e_charts(region, timeline=TRUE) %>%
  e_timeline_opts(currentIndex = last_date_index - 1) %>% 
  em_map("Peru") %>% 
  e_map(confirmed, map = "Peru") %>% 
  e_visual_map(min = 1, max = 2000) %>% 
  e_tooltip(formatter = e_tooltip_choro_formatter("decimal")) %>% 
  e_title(
    text = "Mapa interactivo de casos por región", 
    subtext = "Fuente original: Tweets del MINSA https://twitter.com/Minsa_Peru"
  ) %>% 
  e_theme("infographic")
```

### Densidad de casos por región

```{r echo=FALSE}
map_df2 <- covid_regions_pe %>% 
  select(region, date, confirmed_per_million) %>% 
  mutate(
    region = str_to_title(region) %>% 
      str_replace("Huanuco", "Huánuco") %>% 
      str_replace("Junin", "Junín") %>% 
      str_replace("De Dios", "de Dios") %>% 
      str_replace("Martin", "Martín") %>% 
      str_replace("Apurimac", "Apurímac")
  )

map_df2 %>% 
  group_by(date) %>% 
  e_charts(region, timeline=TRUE) %>%
  e_timeline_opts(currentIndex = last_date_index - 1) %>% 
  em_map("Peru") %>% 
  e_map(confirmed_per_million, map = "Peru") %>% 
  e_visual_map(min = 1, max = 100) %>% 
  e_tooltip(formatter = e_tooltip_choro_formatter("decimal")) %>% 
  e_title(
    text = "Mapa de densidad casos por región (casos por millón)", 
    subtext = "Fuente original: Tweets del MINSA https://twitter.com/Minsa_Peru"
  ) %>% 
  e_theme("infographic")
```


## Column right

### Evolución de casos por región

```{r echo=FALSE}
cpr_df <- covid_regions_pe %>% 
  mutate(
    label = glue::glue("{region}: {confirmed} ({date})")
  )
cpr <- ggplot(cpr_df,
  aes(x = date, y = confirmed, color = region)) +
  #geom_point(show.legend = FALSE) +
  #geom_segment(aes(xend = date, yend = 0), size = 1, show.legend = FALSE) +
  geom_line(show.legend = FALSE, size = 0.5) +
  facet_wrap(~region, scales = "free_y", ncol = 4) +
  theme_minimal() +
  labs(
    y = "Casos Confirmados",
    x = "",
    title = "COVID-19: Casos Confirmados por region en el Perú",
    subtitle = minsa,
    caption = paste0(last_updated, "\n", jmc)
  ) +
  cur_theme
#cpr
ggplotly(cpr)
```

# Datos

## Column {.tabset}

### Totales

```{r results="asis"}
tab_opts <- list(
    language = list(
      search = "Filtrar:",
      url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json'
      ),
    className = "dt-center",
    searchHighlight = TRUE,
    pageLength = 20,
    lengthMenu = c(10, 20, 30, 40, 50),
    dom = 'Blfrtip',
    buttons = c('csv', 'excel')
  )

datatable(
  covid_pe,
  colnames = c("País", "Código ISO", "Fecha", 
               "Número de casos confirmados", 
               "Número de fallecimientos",
               "Número de casos recuperados",
               "Número de casos descartados"),
  class = "cell-border stripe",
  extensions = c("Buttons", "Responsive"),
  options = tab_opts,
  caption = paste0(minsa, " // ", last_updated, " // ", jmc)
)
```


### Por región

```{r results="asis"}
datatable(
  covid_regions_pe,
  colnames = c("Departamento", "Fecha", 
               "Número de casos confirmados",
               "Población (INEI, 2017)",
               "Número de casos por cada millón de personas"
               ),
  class = "cell-border stripe",
  extensions = c("Buttons", "Responsive"),
  options = tab_opts,
  caption = paste0(minsa, " // ", last_updated, " // ", jmc)
)
```

# Estimación de Gompertz

## Columna Izquierda {.tabset}

### Resultados del modelo

**Nota:** Esta es una aproximación cruda al modelo epidemiológico, y no debería tomarse como un resultado oficial ni de alta confiabilidad. Su interés es meramente referencial.

Usaremos la ecuación de Gompertz:

$$
y(t) = a \times e^{-e^{\frac{(\mu \times e)}{a} \times (\lambda - t) + 1}}
$$
Donde los parámetros a ajustar son **a**, **mu** ($\mu$) y **lambda** ($\lambda$)

El resultado de usar todos los datos disponibles se ven a continuación.

```{r comment=""}
df <- read_csv("datos/covid-19-peru-data.csv") %>%
  filter(is.na(region)) %>%
  select(-region, -deaths, -recovered) %>% 
  mutate(
    diff = as.numeric(date - lag(date)),
    diff = if_else(is.na(diff), 0, diff),
    t = cumsum(diff)
  ) %>%
  select(-diff)

# Ref: http://www.statsathome.com/2017/06/07/fitting-non-linear-groth-curves-in-r/
# Ref: https://arxiv.org/pdf/2003.05447.pdf
fit.gompertz <- function(data, time, start = NULL){
  d <- data.frame(y=data, t=time)

  # Must have at least 3 datapoints at different times
  if (length(unique(d$t)) < 3) stop("too few data points to fit curve")

  # Pick starting values ###
  i <- which.max(diff(d$y))
  if (is.null(start)) {
    starting.values <- c(a=max(d$y),
                         mu=max(diff(d$y))/(d[i+1,"t"]-d[i, "t"]),
                         lambda=i)
  } else {
    starting.values = start
  }
#  print("Starting Values for Optimization: ")
#  print(starting.values)
  ##########################

  formula.gompertz <- "y~a*exp(-exp(mu*exp(1)/a*(lambda-t)+1))"
  nls_control <- nls.control(maxiter = 1000, minFactor = 1e-10)
  nls(formula.gompertz, d, starting.values, control = nls_control)
}

# modelo usando los primeros 12 días, 2 días mas luego del
# inicio de la cuarentena
df_inicial <- df %>% filter(t <= 12)
modelo_inicial <- fit.gompertz(df_inicial$confirmed, df_inicial$t)

# modelo usando todos los datos disponibles
start <- c(a = 130000, mu = 1300, lambda = 45)  # to avoid singular gradient
modelo_actual <- fit.gompertz(df$confirmed, df$t, start = start)
summary(modelo_actual)

last_week <- nrow(df) - 7
df_prev <- df %>% 
  slice(1:last_week)
start <- c(a = 130000, mu = 1300, lambda = 45)  # to avoid singular gradient
modelo_previo <- fit.gompertz(df_prev$confirmed, df_prev$t, start = start)
```

Además, esta ecuación tiene un valor de **AIC** de `r AIC(modelo_actual)`.

El gráfico que acompaña a este modelo, presenta (<span style="color: red">**en rojo**</span>) la extrapolación a 7 días de la curva actual. Además, se muestra, <span style="color:orange">**en color naranja**</span>, la curva extrapolada usando los datos de los primeros 12 días desde el primer caso confirmado (que fue el 20202-03-06). Y como referencia, en <span style="color:darkgray">**en gris oscuro**</span> se muestra la curva estimada con los datos hasta las semana anterior.

### Modelos comparativos

#### Modelo con datos de una semana atrás

```{r comment=""}
summary(modelo_previo)
```

#### Modelo con datos de los primeros 12 días

```{r comment=""}
summary(modelo_inicial)
```

## Columna derecha

### Gráfica con extrapolación a 7 días a partir de la fecha (`r Sys.Date()`)

```{r out.height="90%"}
delta_t <- 7
ts_seq <- seq(0, max(df$t) + delta_t)
date_seq <- seq(min(df$date), max(df$date) + delta_t, by = 1)

df_inicial$preds <- predict(modelo_inicial)
futuro_inicial <- predict(modelo_inicial, newdata = data.frame(t = ts_seq))
df_inicial_2 <- data.frame(t = ts_seq, confirmed = futuro_inicial, date = date_seq)

df$preds <- predict(modelo_actual)
future <- predict(modelo_actual, newdata = data.frame(t = ts_seq))
df2 <- data.frame(t = ts_seq, confirmed = future, date = date_seq)

futuro_previo <- predict(modelo_previo, newdata = data.frame(t = ts_seq))
df_prev2 <- data.frame(t = ts_seq, confirmed = futuro_previo, date = date_seq)

max_t <- max(date_seq) + 2
min_t <- min(date_seq) - 2


gompertz_df <- bind_rows(
  df_inicial_2 %>% 
    select(date, t, confirmed) %>% 
    mutate(
      Modelo = "Modelo inicial\n(Primeros 12 días)"
    ),
  df2 %>% 
    select(date, t, confirmed) %>% 
    mutate(
      Modelo = "Modelo actual"
    ),
  df_prev2 %>% 
    select(date, t, confirmed) %>% 
    mutate(
      Modelo = "Modelo previo\n(una semana atrás)"
    )
)

df$Modelo <- NA

labels_df <- gompertz_df %>% 
  group_by(Modelo) %>% 
  summarise(
    date = max(date),
    t = max(t),
    confirmed = last(confirmed)
  )

gompertz_plot <- ggplot() + 
  # inicio de cuarentena
  geom_vline(xintercept = as.Date("2020-03-16"), color = "blue", alpha = 0.5, size = 2) +
  annotate(geom = "text", x = as.Date("2020-03-16") - 1, y = 400, 
           label = "Inicio de la\ncuarentena", hjust = 1, color = "blue") +
  geom_line(
    data = gompertz_df,
    aes(x = date, y = confirmed, 
        group = Modelo, color = Modelo, linetype = Modelo),
    size = 1
  ) +
  geom_point_interactive(
    data = labels_df,
    aes(x = date, y = confirmed, color = Modelo, 
        tooltip = ceiling(confirmed)),
    size = 2,
    show.legend = FALSE
  ) +
  geom_text(
    data = labels_df,
    aes(x = date, y = confirmed, 
        color = Modelo, label = ceiling(confirmed)),
    nudge_y = 50,
    show.legend = FALSE
  ) +
  scale_color_manual(values = c("red", "orange", "darkgray")) +
  scale_linetype_manual(values = c("dashed", "solid", "longdash")) +
  # datos actuales
  geom_point_interactive(
    data = df, 
    aes(x = date, y = confirmed, tooltip = confirmed), 
    inherit.aes = FALSE,
    color = "black",
    show.legend = FALSE
  ) +
  xlim(min_t, max_t) +
  labs(
    y = "Número de casos confirmados",
    x = "",
    title = paste("Actualizado el", lubridate::now(tzone = "UTC"), "UTC"),
    subtitle = "Modelos aproximados (Perú)",
    caption = paste0(last_updated, "\n", jmc)
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(family = "lato"),
    plot.subtitle = element_text(family = "lato"),
    plot.caption = element_text(family = "inconsolata"),
    legend.position = c(.15, .8),
    legend.key.height = unit(.75, "cm"),
    legend.text = element_text(size = 9),
    legend.background = element_blank()
  )

girafe(
  ggobj = gompertz_plot,
  options = list(
    opts_zoom(max = 5),
    opts_sizing(rescale = TRUE, width = .9)
  )
)

#gompertz_plot
#ggplotly(gompertz_plot)
```

#  Acerca de esta visualización

## Columna única

- **Fuente**: Tweets del MINSA https://twitter.com/Minsa_Peru
- **Datos y código**: https://github.com/jmcastagnetto/covid-19-peru-data/

Esta visualización esta hecha usando el lenguaje de programación [R](https://www.r-project.org/),
y hace uso de una serie de librerías ([flexdashboard](https://rmarkdown.rstudio.com/flexdashboard), [ggplot2](https://ggplot2.tidyverse.org/), [echarts4r](https://echarts4r.john-coene.com/), [DT](https://rstudio.github.io/DT/)), para producir los distintos gráficos y tablas.

[`r icon::fa("twitter")`](https://twitter.com/jmcastagnetto)
[`r icon::fa("github")`](https://github.com/jmcastagnetto')
[`r icon::fa("home")`](https://castagnetto.site')
Jesús M. Castagnetto, Ph.D.
